name: Update README last-updated

permissions:
  contents: write

on:
  push:
    branches: [ main, master ]

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Skip if action itself triggered this run
        if: ${{ github.actor == 'github-actions' }}
        run: |
          echo "Triggered by github-actions. Exiting to avoid loop."
          exit 0

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare metadata and update README (Python)
        env:
          TZ: 'Asia/Kolkata'
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          set -euo pipefail

          # locate README (customize path if needed)
          README=README.md
          if [ ! -f "$README" ]; then README=Setup/ReadMe-Softwares-List.md; fi
          if [ ! -f "$README" ]; then
            echo "README not found at expected paths. Exiting."
            exit 0
          fi
          echo "README path: $README"
          echo "README=$README" >> $GITHUB_ENV

          # collect metadata
          NEW_DATE="$(date '+%Y-%m-%d %H:%M %z')"
          REPO="${GITHUB_REPOSITORY}"
          BRANCH="${GITHUB_REF_NAME:-$(echo ${GITHUB_REF} | sed 's#refs/heads/##')}"
          ACTOR="${GITHUB_ACTOR}"
          COMMIT_SHA="$(git rev-parse --short HEAD 2>/dev/null || echo ${GITHUB_SHA:0:7})"
          COMMIT_URL="https://github.com/${REPO}/commit/${COMMIT_SHA}"
          # commit message: prefer git log; otherwise read event payload
          COMMIT_MSG="$(git log -1 --pretty=%s 2>/dev/null || python -c "import json,sys; p=json.load(open('${GITHUB_EVENT_PATH}')); print(p.get('head_commit', {}).get('message',''))" )"
          COMPARE_URL="https://github.com/${REPO}/compare/${GITHUB_SHA}^...${GITHUB_SHA}"
          RUN_URL="https://github.com/${REPO}/actions/runs/${GITHUB_RUN_ID}"
          RUN_NUM="${GITHUB_RUN_NUMBER:-${GITHUB_RUN_ID}}"

          # export for python section (same step runs Python)
          export NEW_DATE REPO BRANCH ACTOR COMMIT_SHA COMMIT_URL COMMIT_MSG COMPARE_URL RUN_URL RUN_NUM README

          # Python: safely replace or insert the block (handles quoting/encoding reliably)
          python - <<'PY'
import os, re, sys

readme = os.environ['README']
new_date = os.environ['NEW_DATE']
repo = os.environ['REPO']
branch = os.environ['BRANCH']
actor = os.environ['ACTOR']
commit_sha = os.environ['COMMIT_SHA']
commit_url = os.environ['COMMIT_URL']
commit_msg = os.environ.get('COMMIT_MSG','').replace('`', "'")
compare_url = os.environ['COMPARE_URL']
run_url = os.environ['RUN_URL']
run_num = os.environ['RUN_NUM']

# Block title we'll write (suggestion used)
title_heading = "## ðŸ“‹ Repository Activity Snapshot"

block = f"""{title_heading}
## ðŸ“… Last Updated : `{new_date}`
## ðŸ“¦ Repository : `{repo}`
## ðŸ”€ Branch : `{branch}`
## ðŸ‘¤ Author : `{actor}`
## ðŸ“ Commit Message : `{commit_msg}`
## ðŸ”— Commit : [{commit_sha}]({commit_url})
## ðŸ“Š Compare : [View changes]({compare_url})
## âš™ï¸ Workflow Run : [Run #{run_num}]({run_url})

---
"""

with open(readme, 'r', encoding='utf-8') as f:
    content = f.read()

# Try to find an existing block starting with either the suggested heading or older "## ðŸ“… Last Updated"
pattern = re.compile(r"(?:##\s*ðŸ“‹\s*Repository\s*Activity\s*Snapshot|##\s*ðŸ“…\s*Last\s*Updated).*?(?=\n##\s|\Z)", re.S)

if pattern.search(content):
    new_content = pattern.sub(block.rstrip(), content, count=1)
else:
    # insert after first H1 (# ...)
    m = re.search(r"^# .*$", content, flags=re.M)
    if m:
        idx = m.end()
        new_content = content[:idx] + "\n\n" + block + content[idx:]
    else:
        # if no H1, prepend
        new_content = block + "\n\n" + content

if new_content != content:
    with open(readme, 'w', encoding='utf-8') as f:
        f.write(new_content)
    print("README updated with Repository Activity Snapshot.")
else:
    print("README already up-to-date.")
PY

      - name: Commit & push if changed
        env:
          GIT_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_NAME: github-actions[bot]
        run: |
          set -euo pipefail

          echo "Using README path: $README"

          if [ -z "${README:-}" ] || [ ! -f "${README:-}" ]; then
            echo "README not set or missing; nothing to commit."
            exit 0
          fi

          git config user.email "$GIT_EMAIL"
          git config user.name "$GIT_NAME"

          if git status --porcelain | grep -q "$(basename "$README")"; then
            git add -- "$README"
            git commit -m "chore: update README Repository Activity Snapshot" || echo "No commit created"
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "No README changes to commit."
          fi
